#!/bin/bash
#

# git_path is the root location where this users git repositories are stored
# change this as needed for each user, or can come up with a common method to
# store local git repos for everybody

usr=$USER
prog=`basename $0`

if [ "${GIT_PATHS}" ]; then
	git_path_full=${GIT_PATHS}
else
	# update to use /corp/global/tools/bin/gittools/get_my_workspace to get root path
	git_path_full=~/git
fi

# Git server definitions
git_server=git@hq1-up-gitbna-1.brocade.com
remote_repo=san/endor.git

# Look for default git root directory
if [ ! $git_path_full ]; then
	echo ""
	echo "GIT Directory $git_path_full not defined. Unable to proceed."
	echo ""
	echo "   Please either create symlink at ~/git pointing to your /zzz workspace"
	echo "   or define GIT_PATHS pointing to your /zzz workspace in your shell"
	echo "   resource file."
	echo ""
	echo "   Example: ln -s /zzz/work05/dh404494/git_repositories ~/git"
	echo "      or"
	echo "   Example: export GIT_PATHS=/zzz/work05/dh404494/git_repositories"
	echo ""
	exit 1
fi

# If local-repo name specified, set variable
if [ "$#" -eq "1" ]; then
	git_repo=$1
fi

# If local-repo not specified, list existing repositories and query for repo
if [ "$git_repo" == "" ]; then
	echo "Repo not specified."
	echo ""
	for path in ${git_path_full//:/ }; do
		ls -w 1 ${path}
	done
	echo ""
	read -p "Specify repository: " git_repo
fi

# Loop through directories in git_path_full looking for a match
paths=0
for path in ${git_path_full//:/ }; do
	if  [ -d ${path}/${git_repo} ]; then
		git_path=${path}
		break;
	fi
	let paths+=1
done

if [ ! ${git_path} ]; then
	echo "Repository ${git_repo} not found. Existing repositories:"
	echo ""
	for path in ${git_path_full//:/ }; do
		ls -w 1 ${path}
	done
	echo ""
	while true; do
		read -p "Would you like to create a new repository? [y/n]: " yn
		case $yn in
		[Yy]*) break;;
		[Nn]*) exit 1;;
		* ) echo "Please answer yes or no.";;
		esac
	done

	if [ $paths -gt 1 ]; then
		echo ""
		echo "Available paths:"
		echo ""
		echo "${git_path_full//:/$'\n'}"
		echo ""
		read -p "Which path do you want to store the new repo: " git_path
		echo ""
	fi

	if [ ! -d ${git_path} ]; then
		echo "GIT path:${git_path} does not exist. Unable to proceed."
		exit 1
	fi

	mkdir ${git_path}/${git_repo}
fi

git_root=${git_path}/${git_repo}

# Check if there is a repo already cloned here
if [ ! -d ${git_root}/.git ]; then
	echo "Did not find expected local repo. Suspect no repository has been cloned."
	while true; do
		read -p "Do you wish to clone a repo from ${git_server}? [y/n]: " yn
		case $yn in

		[Yy]*)
			cd ${git_path}
			echo ""
			echo "Available branches:"
			echo ""
			git ls-remote --head ${git_server}:${remote_repo} | sed -e 's|.*refs/heads/||' | grep -v priv
			echo ""
			read -p "Which branch do you want to clone: " branch
			echo ""
			git clone -b ${branch} ${git_server}:${remote_repo} ${git_repo}
			if [ $? -ne 0 ]; then
				echo "Clone failed. Unable to create repository."
				exit 1
			fi
			echo ""
			break
			;;

		[Nn]*) break;;
		* ) echo "Please answer yes or no.";;
		esac
	done
fi

env GIT_ROOT=${git_root} GIT_PATH=${git_path} GIT_REPO=${git_repo} ${SHELL}
