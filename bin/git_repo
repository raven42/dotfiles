#!/bin/bash
#

# git_path is the root location where this users git repositories are stored
# change this as needed for each user, or can come up with a common method to
# store local git repos for everybody

usr=$USER
prog=`basename $0`

if [ "${GIT_PATH}" ]; then
	git_path=${GIT_PATH}
else
	git_path=~/git
fi

# Git server definitions
git_server=git@hq1-up-gitbna-1.brocade.com
remote_repo=san/endor.git

# Look for default git root directory
if [ ! -d $git_path ]; then
	echo ""
	echo "GIT Directory $git_path not defined. Unable to proceed."
	echo ""
	echo "   Please either create symlink at ~/git pointing to your /zzz workspace"
	echo "   or define GIT_PATH pointing to your /zzz workspace in your shell"
	echo "   resource file."
	echo ""
	echo "   Example: ln -s /zzz/work05/dh404494/git_repositories ~/git"
	echo "      or"
	echo "   Example: GIT_PATH=/zzz/work05/dh404494/git_repositories"
	echo ""
	exit 1
fi

# If local-repo name specified, set variable
if [ "$#" -eq "1" ]; then
	git_repo=$1
fi

# If local-repo not specified, list existing repositories and query for repo
if [ "$git_repo" == "" ]; then
	echo "Repo not specified."
	echo ""
	ls -w 1 $git_path
	echo ""
	read -p "Specify repository: " git_repo
fi

git_root=${git_path}/${git_repo}

if [ ! -d ${git_root} ]; then
	echo "Repository ${git_repo} not found. Existing repositories:"
	echo ""
	ls -w 1 ${git_path}
	echo ""
	while true; do
		read -p "Would you like to create a new repository? [y/n]: " yn
		case $yn in
		[Yy]*) break;;
		[Nn]*) exit 1;;
		* ) echo "Please answer yes or no.";;
		esac
	done

	mkdir ${git_root}
fi

# Check if there is a repo already cloned here
if [ ! -d ${git_root}/.git ]; then
	echo "Did not find expected local repo. Suspect no repository has been cloned."
	while true; do
		read -p "Do you wish to clone a repo from ${git_server}? [y/n]: " yn
		case $yn in

		[Yy]*)
			cd ${git_path}
			echo ""
			echo "Available branches:"
			echo ""
			git ls-remote --head ${git_server}:${remote_repo} | sed -e 's|.*refs/heads/||' | grep -v priv
			echo ""
			read -p "Which branch do you want to clone: " branch
			echo ""
			git clone -b ${branch} ${git_server}:${remote_repo} ${git_repo}
			if [ $? -ne 0 ]; then
				echo "Clone failed. Unable to create repository."
				exit 1
			fi
			echo ""
			break
			;;

		[Nn]*) break;;
		* ) echo "Please answer yes or no.";;
		esac
	done
fi

env GIT_ROOT=${git_root} GIT_PATH=${git_path} GIT_REPO=${git_repo} ${SHELL}
